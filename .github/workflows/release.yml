name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.2.0)'
        required: true

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      release_upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.VERSION }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # „Éï„É´historyÂèñÂæóÔºà„É™„É™„Éº„Çπ„Éé„Éº„ÉàÁîüÊàêÁî®Ôºâ

      - name: Validate pubkey configuration
        run: |
          PUBKEY=$(jq -r '.plugins.updater.pubkey' src-tauri/tauri.conf.json)
          if [ -z "$PUBKEY" ] || [ "$PUBKEY" == "null" ]; then
            echo "::error::pubkey is not configured in tauri.conf.json"
            echo "Please generate signing keys with 'npx tauri signer generate' and set the pubkey"
            exit 1
          fi
          echo "‚úì pubkey is configured"

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Generate release notes
        id: release_notes
        run: |
          # ÂâçÂõû„ÅÆ„Çø„Ç∞„ÇíÂèñÂæó
          # workflow_dispatchÊôÇ„ÅØHEAD„Å´Êñ∞„Çø„Ç∞„Åå„Å™„ÅÑ„Åü„ÇÅ„ÄÅÁõ¥Ëøë„ÅÆ„Çø„Ç∞„ÇíÂèñÂæó
          # „Çø„Ç∞„Éó„ÉÉ„Ç∑„É•ÊôÇ„ÅØHEAD^„Åã„ÇâÂâçÂõû„Çø„Ç∞„ÇíÂèñÂæó
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          else
            PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          fi

          if [ -z "$PREV_TAG" ]; then
            # ÂàùÂõû„É™„É™„Éº„Çπ„ÅÆÂ†¥Âêà
            COMMITS=$(git log --pretty=format:"%s" --no-merges)
          else
            # ÂâçÂõû„Çø„Ç∞„Åã„Çâ„ÅÆÂ∑ÆÂàÜ
            COMMITS=$(git log ${PREV_TAG}..HEAD --pretty=format:"%s" --no-merges)
          fi

          # Conventional CommitsÂΩ¢Âºè„Åß„Éë„Éº„Çπ„Åó„Å¶ÂàÜÈ°û
          FEATURES=""
          FIXES=""
          OTHERS=""

          while IFS= read -r commit; do
            [ -z "$commit" ] && continue
            if [[ "$commit" =~ ^feat(\(.+\))?:\ (.+) ]]; then
              FEATURES="${FEATURES}- ${BASH_REMATCH[2]}\n"
            elif [[ "$commit" =~ ^fix(\(.+\))?:\ (.+) ]]; then
              FIXES="${FIXES}- ${BASH_REMATCH[2]}\n"
            elif [[ "$commit" =~ ^docs:\ |^chore:\ |^ci:\ |^test:\ |^refactor:\ ]]; then
              # „Éâ„Ç≠„É•„É°„É≥„Éà„ÉªCI„Éª„ÉÜ„Çπ„ÉàÁ≠â„ÅØ„Çπ„Ç≠„ÉÉ„Éó
              continue
            else
              # „Åù„ÅÆ‰ªñ„ÅÆÂ§âÊõ¥
              OTHERS="${OTHERS}- ${commit}\n"
            fi
          done <<< "$COMMITS"

          # „É™„É™„Éº„Çπ„Éé„Éº„ÉàÁîüÊàê
          NOTES=""
          if [ -n "$FEATURES" ]; then
            NOTES="${NOTES}## ‚ú® Êñ∞Ê©üËÉΩ\n${FEATURES}\n"
          fi
          if [ -n "$FIXES" ]; then
            NOTES="${NOTES}## üêõ „Éê„Ç∞‰øÆÊ≠£\n${FIXES}\n"
          fi
          if [ -n "$OTHERS" ]; then
            NOTES="${NOTES}## üìù „Åù„ÅÆ‰ªñ„ÅÆÂ§âÊõ¥\n${OTHERS}\n"
          fi

          # „Éá„Éï„Ç©„É´„Éà„É°„ÉÉ„Çª„Éº„Ç∏
          if [ -z "$NOTES" ]; then
            NOTES="## üéâ „É™„É™„Éº„Çπ\n- ÂêÑÁ®ÆÊîπÂñÑ„Å®‰øÆÊ≠£\n\n"
          fi

          # „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Çª„ÇØ„Ç∑„Éß„É≥ËøΩÂä†
          NOTES="${NOTES}## üì• „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ\n„Åä‰Ωø„ÅÑ„ÅÆOS„Å´Âêà„Çè„Åõ„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö\n- Windows: \`.msi\` „Åæ„Åü„ÅØ \`.exe\` „Éï„Ç°„Ç§„É´\n- macOS: \`.dmg\` „Éï„Ç°„Ç§„É´"

          # Âá∫ÂäõÔºàË§áÊï∞Ë°åÂØæÂøú„ÄÅ‰∏ÄÊÑè„Å™„Éá„É™„Éü„Çø„Çí‰ΩøÁî®Ôºâ
          echo "NOTES<<RELEASE_NOTES_EOF" >> $GITHUB_OUTPUT
          echo -e "$NOTES" >> $GITHUB_OUTPUT
          echo "RELEASE_NOTES_EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.get_version.outputs.VERSION }}
          name: VTuber Overlay Suite v${{ steps.get_version.outputs.VERSION }}
          body: ${{ steps.release_notes.outputs.NOTES }}
          draft: true
          prerelease: false

  build:
    needs: create-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            target: aarch64-apple-darwin
          - platform: macos-latest
            target: x86_64-apple-darwin
          - platform: windows-latest
            target: x86_64-pc-windows-msvc

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install dependencies (macOS)
        if: matrix.platform == 'macos-latest'
        run: |
          brew install protobuf

      - name: Install dependencies (Windows)
        if: matrix.platform == 'windows-latest'
        run: |
          choco install protoc

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          releaseId: ${{ needs.create-release.outputs.release_id }}
          args: --target ${{ matrix.target }}

  publish-release:
    needs: [create-release, build]
    runs-on: ubuntu-latest
    steps:
      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.create-release.outputs.version }}
          draft: false
