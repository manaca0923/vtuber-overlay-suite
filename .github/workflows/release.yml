name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.2.0)'
        required: true

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      release_upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.VERSION }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ãƒ•ãƒ«historyå–å¾—ï¼ˆãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆç”Ÿæˆç”¨ï¼‰

      - name: Validate pubkey configuration
        run: |
          PUBKEY=$(jq -r '.plugins.updater.pubkey' src-tauri/tauri.conf.json)
          if [ -z "$PUBKEY" ] || [ "$PUBKEY" == "null" ]; then
            echo "::error::pubkey is not configured in tauri.conf.json"
            echo "Please generate signing keys with 'npx tauri signer generate' and set the pubkey"
            exit 1
          fi
          echo "âœ“ pubkey is configured"

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Generate release notes
        id: release_notes
        run: |
          # å‰å›ã®ã‚¿ã‚°ã‚’å–å¾—
          # workflow_dispatchæ™‚ã¯HEADã«æ–°ã‚¿ã‚°ãŒãªã„ãŸã‚ã€ç›´è¿‘ã®ã‚¿ã‚°ã‚’å–å¾—
          # ã‚¿ã‚°ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã¯HEAD^ã‹ã‚‰å‰å›ã‚¿ã‚°ã‚’å–å¾—
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          else
            PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          fi

          if [ -z "$PREV_TAG" ]; then
            # åˆå›ãƒªãƒªãƒ¼ã‚¹ã®å ´åˆ
            COMMITS=$(git log --pretty=format:"%s" --no-merges)
          else
            # å‰å›ã‚¿ã‚°ã‹ã‚‰ã®å·®åˆ†
            COMMITS=$(git log ${PREV_TAG}..HEAD --pretty=format:"%s" --no-merges)
          fi

          # Conventional Commitså½¢å¼ã§ãƒ‘ãƒ¼ã‚¹ã—ã¦åˆ†é¡
          BREAKING=""
          FEATURES=""
          FIXES=""
          PERF=""
          REVERT=""
          OTHERS=""

          while IFS= read -r commit; do
            [ -z "$commit" ] && continue
            # Breaking Changes: feat!: / fix!: / perf!: / revert!: (ã‚¹ã‚³ãƒ¼ãƒ—ã‚ã‚Š/ãªã—)
            if [[ "$commit" =~ ^(feat|fix|perf|revert)(\(.+\))?!:\ (.+) ]]; then
              BREAKING="${BREAKING}- ${BASH_REMATCH[3]}\n"
            # æ–°æ©Ÿèƒ½: feat:
            elif [[ "$commit" =~ ^feat(\(.+\))?:\ (.+) ]]; then
              FEATURES="${FEATURES}- ${BASH_REMATCH[2]}\n"
            # ãƒã‚°ä¿®æ­£: fix:
            elif [[ "$commit" =~ ^fix(\(.+\))?:\ (.+) ]]; then
              FIXES="${FIXES}- ${BASH_REMATCH[2]}\n"
            # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„: perf:
            elif [[ "$commit" =~ ^perf(\(.+\))?:\ (.+) ]]; then
              PERF="${PERF}- ${BASH_REMATCH[2]}\n"
            # ãƒªãƒãƒ¼ãƒˆ: revert:
            elif [[ "$commit" =~ ^revert(\(.+\))?:\ (.+) ]]; then
              REVERT="${REVERT}- ${BASH_REMATCH[2]}\n"
            # ã‚¹ã‚­ãƒƒãƒ—: docs, chore, ci, test, refactor, style
            elif [[ "$commit" =~ ^(docs|chore|ci|test|refactor|style):\ ]]; then
              continue
            else
              # ãã®ä»–ã®å¤‰æ›´
              OTHERS="${OTHERS}- ${commit}\n"
            fi
          done <<< "$COMMITS"

          # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆç”Ÿæˆï¼ˆé‡è¦åº¦é †: ç ´å£Šçš„å¤‰æ›´ > æ–°æ©Ÿèƒ½ > ãƒã‚°ä¿®æ­£ > ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ > ãƒªãƒãƒ¼ãƒˆ > ãã®ä»–ï¼‰
          NOTES=""
          if [ -n "$BREAKING" ]; then
            NOTES="${NOTES}## âš ï¸ ç ´å£Šçš„å¤‰æ›´\n${BREAKING}\n"
          fi
          if [ -n "$FEATURES" ]; then
            NOTES="${NOTES}## âœ¨ æ–°æ©Ÿèƒ½\n${FEATURES}\n"
          fi
          if [ -n "$FIXES" ]; then
            NOTES="${NOTES}## ğŸ› ãƒã‚°ä¿®æ­£\n${FIXES}\n"
          fi
          if [ -n "$PERF" ]; then
            NOTES="${NOTES}## âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„\n${PERF}\n"
          fi
          if [ -n "$REVERT" ]; then
            NOTES="${NOTES}## ğŸ”„ ãƒªãƒãƒ¼ãƒˆ\n${REVERT}\n"
          fi
          if [ -n "$OTHERS" ]; then
            NOTES="${NOTES}## ğŸ“ ãã®ä»–ã®å¤‰æ›´\n${OTHERS}\n"
          fi

          # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          if [ -z "$NOTES" ]; then
            NOTES="## ğŸ‰ ãƒªãƒªãƒ¼ã‚¹\n- å„ç¨®æ”¹å–„ã¨ä¿®æ­£\n\n"
          fi

          # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ 
          NOTES="${NOTES}## ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰\nãŠä½¿ã„ã®OSã«åˆã‚ã›ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ï¼š\n- Windows: \`.msi\` ã¾ãŸã¯ \`.exe\` ãƒ•ã‚¡ã‚¤ãƒ«\n- macOS: \`.dmg\` ãƒ•ã‚¡ã‚¤ãƒ«"

          # å‡ºåŠ›ï¼ˆè¤‡æ•°è¡Œå¯¾å¿œã€ä¸€æ„ãªãƒ‡ãƒªãƒŸã‚¿ã‚’ä½¿ç”¨ï¼‰
          echo "NOTES<<RELEASE_NOTES_EOF" >> $GITHUB_OUTPUT
          echo -e "$NOTES" >> $GITHUB_OUTPUT
          echo "RELEASE_NOTES_EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.get_version.outputs.VERSION }}
          name: VTuber Overlay Suite v${{ steps.get_version.outputs.VERSION }}
          body: ${{ steps.release_notes.outputs.NOTES }}
          draft: true
          prerelease: false

  build:
    needs: create-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            target: aarch64-apple-darwin
          - platform: macos-latest
            target: x86_64-apple-darwin
          - platform: windows-latest
            target: x86_64-pc-windows-msvc

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install dependencies (macOS)
        if: matrix.platform == 'macos-latest'
        run: |
          brew install protobuf

      - name: Install dependencies (Windows)
        if: matrix.platform == 'windows-latest'
        run: |
          choco install protoc

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          releaseId: ${{ needs.create-release.outputs.release_id }}
          args: --target ${{ matrix.target }}

  publish-release:
    needs: [create-release, build]
    runs-on: ubuntu-latest
    steps:
      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.create-release.outputs.version }}
          draft: false
