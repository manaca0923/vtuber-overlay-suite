# 3カラム・テンプレ要件仕様書（追記版 v1.1：Grid/CSS + slot座標表 + 推奨タイポグラフィ + JSON Schema/検証/運用）
- Version: **1.1**
- 更新日: **2025-12-25**
- 対象: **MVP（slot固定／安全な可変パラメータ）**
- 想定: **OBS Browser Source / 1920×1080（16:9）**

---

## 追記の目的（v1.1）
v1.0の追記（Grid/CSS・slot座標表・タイポ）に加え、**実装で詰まりやすい論点**を仕様として固定します。

- テンプレJSONの **スキーマ（JSON Schema）**
- 設定の **クランプ/検証規約**
- CSS変数とテンプレ設定の **マッピング（Design Token）**
- OBS運用（ブラウザソース、セーフエリア、トラブルシュート）
- パフォーマンス予算（DOM/更新間引き/アニメ指針）
- デザイナー向け納品チェックリスト（神テンプレ制作の品質担保）

---

# 7. Gridテンプレ（CSS）

## 7.1 基本方針
- 画面全体は `layout-root` で **3カラムを確定（比率固定）**。
- 各カラム内部は **縦方向Grid** を持ちslotを配置。
- 可変要素（コメント/セトリ/短冊）は **枠内で制御**（maxLines/maxItems・ellipsis・fade）し、枠外へ溢れない。

## 7.2 CSS Gridテンプレ（MVP固定）
```css
:root {
  --gutter: 24px;            /* カラム間 */
  --safe-top: 4vh;           /* セーフエリア（推奨：4〜6%） */
  --safe-right: 4vw;
  --safe-bottom: 5vh;
  --safe-left: 4vw;

  --left: 22%;
  --center: 56%;
  --right: 22%;

  --radius: 14px;
  --panel-bg: rgba(0,0,0,0.25);
  --panel-blur: 10px;

  --text: #fff;
  --shadow: rgba(0,0,0,0.55);
}

html, body { width: 100%; height: 100%; margin: 0; }

.layout-root {
  position: relative;
  width: 100%;
  height: 100%;
  padding: var(--safe-top) var(--safe-right) var(--safe-bottom) var(--safe-left);
  box-sizing: border-box;

  display: grid;
  grid-template-columns: var(--left) var(--center) var(--right);
  column-gap: var(--gutter);
}

/* 各カラム（縦方向のslot） */
.col-left, .col-center, .col-right {
  height: 100%;
  display: grid;
  row-gap: 16px;
}

/* 左：時計→天気→コメント→スパチャ→ロゴ */
.col-left {
  grid-template-rows:
    auto          /* left.top */
    auto          /* left.topBelow */
    1fr           /* left.middle */
    auto          /* left.lower */
    auto;         /* left.bottom */
}

/* 中央：主役ステージ */
.col-center { grid-template-rows: 1fr; }

/* 右：ラベル→セトリ→（KPI/短冊）→告知 */
.col-right {
  grid-template-rows:
    auto
    1fr
    auto
    auto;
}

/* 右下段（KPI + 短冊） */
.right-lower-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  column-gap: 16px;
  align-items: end;
}

/* 共通：パネル */
.panel {
  background: var(--panel-bg);
  backdrop-filter: blur(var(--panel-blur));
  -webkit-backdrop-filter: blur(var(--panel-blur));
  border-radius: var(--radius);
  padding: 12px 14px;
  box-sizing: border-box;
}

/* 破綻防止：枠外へ出さない */
.clamp-box { overflow: hidden; }
.scroll-y { overflow-y: auto; }
.ellipsis { overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
```

## 7.3 HTML slotマッピング（参考）
```html
<div class="layout-root">
  <div class="col-left">
    <section id="left.top"></section>
    <section id="left.topBelow" class="panel"></section>
    <section id="left.middle" class="clamp-box"></section>
    <section id="left.lower"></section>
    <section id="left.bottom"></section>
  </div>

  <div class="col-center">
    <section id="center.full"></section>
  </div>

  <div class="col-right">
    <section id="right.top"></section>
    <section id="right.upper" class="clamp-box"></section>

    <div class="right-lower-grid">
      <section id="right.lowerLeft"></section>
      <section id="right.lowerRight" class="clamp-box"></section>
    </div>

    <section id="right.bottom"></section>
  </div>
</div>
```

---

# 8. slot座標表（推奨寸法・挙動）

## 8.1 基準
- キャンバス: 1920×1080
- セーフエリア: 上4% / 右4% / 下5% / 左4%（推奨）
- ガター: 24px / row-gap: 16px / panel padding: 12×14px

## 8.2 slot一覧（推奨）
| slot | 役割 | 推奨高さ/挙動 | 破綻防止ルール |
|---|---|---|---|
| left.top | 時刻/日付 | auto | 2行固定（時刻＋日付） |
| left.topBelow | 天気 | auto | 情報量最小、長文禁止 |
| left.middle | コメント | 1fr（可変） | `maxLines`必須、fade/ellipsis |
| left.lower | スパチャ | auto | 最小表示秒数＋キュー |
| left.bottom | ロゴ/注意 | auto | 小さめ、透過 |
| center.full | 主役 | 1fr | 左右侵食禁止 |
| right.top | ラベル | auto | 1行固定 |
| right.upper | セトリ | 1fr（可変） | `maxItems`必須、ellipsis |
| right.lowerLeft | KPI | auto | 更新頻度抑制（2〜5秒） |
| right.lowerRight | 短冊 | auto〜中 | `maxItems`必須、空なら非表示 |
| right.bottom | 告知 | auto | 原則cycle表示 |

---

# 9. 推奨フォントサイズ表（1920×1080基準）
| ブロック | 推奨サイズ | ウェイト | 備考 |
|---|---:|---:|---|
| Clock（時刻） | 64〜80px | 600 | 1行で読める |
| Clock（日付） | 22〜26px | 500〜600 | 省略可 |
| Weather | 20〜24px | 500〜600 | 要素最小 |
| Chat（名前） | 20〜24px | 600 | 色分け控えめ |
| Chat（本文） | 20〜24px | 500 | line-height 1.3〜1.45 |
| SuperChat（金額） | 28〜36px | 700 | カード強調 |
| SetList | 18〜24px | 500〜600 | 長文ellipsis |
| KPI（主数字） | 56〜72px | 700 | 視線誘導の釘 |
| KPI（副数字） | 24〜32px | 600 | 2項目まで |
| Promo | 18〜28px | 500〜700 | cycle推奨 |
| Notice | 14〜16px | 500 | 邪魔しない |

## 9.1 文字効果（標準）
- shadow: blur 8 / opacity 0.55 / offset 2,2
- outline: 2px / rgba(0,0,0,0.55)

---

# 10. 実装ルール（MVPでの落とし穴回避）

## 10.1 更新間引き（必須）
- コメント高頻度時は **100ms〜200ms単位**でまとめて反映（DOM更新を抑制）。
- requestAnimationFrameにまとめるか、キューをバッチ反映する。

## 10.2 上限値の強制（必須）
- ChatLog: `maxLines` 必須（推奨10 / 範囲 4〜14）
- SetList: `maxItems` 必須（推奨14 / 範囲 6〜20）
- QueueList: `maxItems` 必須（推奨6 / 範囲 3〜10）

## 10.3 右下過密対策（必須）
- PromoPanel: `displayMode=cycle` をデフォルト
  - cycleSec=30 / showSec=6（推奨）
- QueueList: `showWhenNotEmpty=true` をデフォルト

---

# 12. テンプレJSON仕様（MVP）

## 12.1 データモデル（概要）
- `layout`：3カラム比率・ガター・セーフエリア
- `theme`：色・パネル・タイポ・影/アウトライン
- `components[]`：slot固定配置、enabled/style/rules/tuning

## 12.2 許可する可変項目（MVP）
- enabled: 表示ON/OFF
- style: 色/透明度/フォント/影/アウトライン/パネル（default/none/solid）
- tuning: offsetX/offsetY（クランプ必須）
- rules: maxLines/maxItems/overflow/cycleSec/showSec 等

---

# 13. JSON Schema（MVPテンプレ）
> 実装では **このSchemaで検証**し、危険値は拒否（400）またはクランプして適用します。

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.local/schema/template-mvp-1.0.json",
  "type": "object",
  "required": ["layout", "safeAreaPct", "components"],
  "properties": {
    "layout": {
      "type": "object",
      "required": ["type", "leftPct", "centerPct", "rightPct", "gutterPx"],
      "properties": {
        "type": { "const": "threeColumn" },
        "leftPct": { "type": "number", "minimum": 0.18, "maximum": 0.28 },
        "centerPct": { "type": "number", "minimum": 0.44, "maximum": 0.64 },
        "rightPct": { "type": "number", "minimum": 0.18, "maximum": 0.28 },
        "gutterPx": { "type": "integer", "minimum": 0, "maximum": 64 }
      },
      "additionalProperties": false
    },
    "safeAreaPct": {
      "type": "object",
      "required": ["top", "right", "bottom", "left"],
      "properties": {
        "top": { "type": "number", "minimum": 0.0, "maximum": 0.10 },
        "right": { "type": "number", "minimum": 0.0, "maximum": 0.10 },
        "bottom": { "type": "number", "minimum": 0.0, "maximum": 0.10 },
        "left": { "type": "number", "minimum": 0.0, "maximum": 0.10 }
      },
      "additionalProperties": false
    },
    "theme": {
      "type": "object",
      "properties": {
        "fontFamily": { "type": "string" },
        "textColor": { "type": "string" },
        "panel": {
          "type": "object",
          "properties": {
            "bg": { "type": "string" },
            "blurPx": { "type": "integer", "minimum": 0, "maximum": 24 },
            "radiusPx": { "type": "integer", "minimum": 0, "maximum": 32 }
          },
          "additionalProperties": false
        },
        "shadow": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean" },
            "blur": { "type": "integer", "minimum": 0, "maximum": 24 },
            "opacity": { "type": "number", "minimum": 0.0, "maximum": 1.0 },
            "offsetX": { "type": "integer", "minimum": -20, "maximum": 20 },
            "offsetY": { "type": "integer", "minimum": -20, "maximum": 20 }
          },
          "additionalProperties": false
        },
        "outline": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean" },
            "width": { "type": "integer", "minimum": 0, "maximum": 6 },
            "color": { "type": "string" }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": true
    },
    "components": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["id", "type", "slot", "enabled"],
        "properties": {
          "id": { "type": "string", "minLength": 1 },
          "type": {
            "type": "string",
            "enum": [
              "ClockWidget","WeatherWidget","ChatLog","SuperChatCard","BrandBlock",
              "MainAvatarStage","ChannelBadge","SetList","KPIBlock","PromoPanel","QueueList"
            ]
          },
          "slot": {
            "type": "string",
            "enum": [
              "left.top","left.topBelow","left.middle","left.lower","left.bottom",
              "center.full",
              "right.top","right.upper","right.lowerLeft","right.lowerRight","right.bottom"
            ]
          },
          "enabled": { "type": "boolean" },
          "style": { "type": "object" },
          "rules": { "type": "object" },
          "tuning": {
            "type": "object",
            "properties": {
              "offsetX": { "type": "integer", "minimum": -40, "maximum": 40 },
              "offsetY": { "type": "integer", "minimum": -40, "maximum": 40 }
            },
            "additionalProperties": false
          }
        },
        "additionalProperties": true
      }
    }
  },
  "additionalProperties": false
}
```

---

# 14. クランプ規約（必須）
> Schemaで弾ききれない場合の「実装側の最終防衛ライン」です。

## 14.1 数値クランプ
- `offsetX/offsetY`: -40〜+40（px相当）
- `maxLines`: 4〜14
- `maxItems`: 6〜20
- `cycleSec`: 10〜120
- `showSec`: 3〜15

## 14.2 文字列正規化（安全）
- Chatの表示名/本文：HTMLエスケープ（`<`, `>`, `&`, `"`）
- 改行：最大2行まで（それ以上は省略）

## 14.3 表示の縮退（過密時）
- KPI/Promo/Queueが同時に要求された場合：
  1) Promoはcycleに強制
  2) Queueは空なら非表示
  3) KPIはcompactへ縮退（副指標を減らす）

---

# 15. Design Token（JSON → CSS変数マッピング）
| JSON | CSS Variable | 用途 |
|---|---|---|
| `layout.gutterPx` | `--gutter` | カラム間 |
| `safeAreaPct.top` | `--safe-top` | セーフエリア |
| `theme.panel.bg` | `--panel-bg` | パネル背景 |
| `theme.panel.blurPx` | `--panel-blur` | ブラー |
| `theme.panel.radiusPx` | `--radius` | 角丸 |
| `theme.textColor` | `--text` | 文字色 |
| `theme.shadow.opacity` | `--shadow` | 影色（実装側で合成） |

> MVPでは「CSS変数で表現できる範囲」を優先し、個別コンポーネントが独自実装しないよう統制します。

---

# 16. OBS運用仕様（Browser Source）

## 16.1 設定推奨
- 幅: 1920 / 高さ: 1080
- FPS: 30（安定優先。60はPhase2で検討）
- カスタムCSS: 不要（テンプレ内で完結）
- ループ動画/アニメ：MVPは控えめ（CPU/GPU負荷を避ける）

## 16.2 セーフエリア運用
- 端が欠ける環境を想定し、重要情報は safeArea内に配置
- 特に左右カラムのテキストが端に寄りすぎないこと

## 16.3 トラブルシュート（よくある）
- **真っ白**：localhostポート/URLが違う → `/health`で確認
- **重い**：コメントが多い → maxLinesを下げ、更新間引きを有効化
- **文字が読めない**：panel/bg/outlineを強める（標準値へ戻す）

---

# 17. パフォーマンス予算（MVP）
- Chat DOM行数：最大 `maxLines` の 1.5倍まで（入れ替え中の一時増加を許容）
- 更新間隔：UI反映は 100〜200ms バッチ
- アニメーション：CSS transitionは opacity/transformのみ（layout/paintを避ける）
- 画像：背景は1枚、透過PNGは枚数を制限（目安10枚以内）

---

# 18. デザイナー納品チェックリスト（神テンプレ品質担保）
- [ ] 1920×1080で破綻しない（safeArea考慮）
- [ ] 背景が明るい/暗い双方で文字が読める（影/アウトライン前提）
- [ ] 右下は常時過密にならない（Promoはcycle想定）
- [ ] 文字サイズは推奨表に収まる（特にClock/KPI）
- [ ] 長い曲名/コメントが来ても崩れない（ellipsis/fade設計）
- [ ] 小物/枠の解像度不足がない（拡大時にジャギらない）
- [ ] ライセンス明確（フォント/素材）

---

# 19. 受け入れ基準（v1.1）
1. 3カラム比率が維持され、中央主役が侵食されない  
2. slotが枠外へはみ出さない（clampが機能）  
3. コメント/セトリ/短冊が上限・省略で破綻しない  
4. 推奨タイポで縮小視聴でも主要情報が判読できる  
5. JSON Schemaで検証でき、危険値は拒否/クランプされる  
6. OBSで長時間運用しても顕著なフレーム落ちがない（更新間引きが効く）  

---
**End of Document**
