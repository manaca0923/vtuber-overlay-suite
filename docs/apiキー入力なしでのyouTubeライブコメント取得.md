# 要求仕様書：apiキー入力なしでのyouTubeライブコメント取得（you Tube Data Api + Stream List G Rpc）

## 0. 文書情報

* 文書名：APIキー入力なしでのYouTubeライブコメント取得（YouTube Data API + streamList gRPC）
* 版数：v1.0
* 作成日：2025-12-22
* 作成者：—
* 想定読者：プロダクトオーナー／開発（クライアント）／運用（SRE/サポート）／セキュリティ・法務

---

## 1. 背景・目的

### 1.1 背景

配信者向けデスクトップアプリにおいて、**ユーザーがAPIキーを入力せず**に、YouTubeライブ配信のURL（または動画ID）だけでライブチャットコメントを取得したい。

### 1.2 目的

* ユーザー操作を最小化し、導入障壁を下げる（URL貼り付けのみで動作）。
* YouTube Data API を**正式な利用形態**（API key/OAuthのいずれかを用いた認証・規約順守）で運用する。
* 大規模利用に耐えるため、**クォータ枯渇・キー濫用・障害**に対して被害を局所化し、復旧を容易にする。

---

## 2. 用語

* **APIキー入力なし**：ユーザーがキーを手入力しないこと。アプリが内部でAPI key（またはOAuthトークン）を付与してAPIを呼び出す。
* **公開配信**：視聴にログインを要しない配信。
* **限定配信**：メンバー限定／限定公開など、視聴やチャット取得に認可が必要な配信。
* **liveChatId**：YouTubeライブチャットを識別するID。
* **streamList**：YouTubeライブチャットを server-streaming（gRPC）で受信する方式。
* **クォータ**：Google/YouTube APIのプロジェクト単位の利用枠（単位/日など）。

---

## 3. スコープ

### 3.1 対象

* デスクトップアプリ（Windows / macOS を想定。Linuxは任意）
* YouTubeライブ配信のチャットコメント取得
* 取得したコメントをアプリ内表示、またはローカル連携（例：ローカルHTTP API、WebSocket、ファイル出力）に供給

### 3.2 非対象（Out of Scope）

* YouTube以外の配信プラットフォーム対応
* 収集したコメントのクラウド保存・中央集約（本仕様の既定は「クライアント直結」）
* YouTubeの非公開API（いわゆるInnerTube等）に依存した実装

---

## 4. 前提・制約

1. YouTube Data API の利用は、適用される利用規約・ポリシーに従うこと。
2. 認証は **API key または OAuth 2.0** のいずれかで行う（リクエスト無認証は不可）。
3. 「ログイン不要での取得」は**公開配信に限定**され、限定配信・保留コメント等は OAuth ログインが必要になり得る。
4. デスクトップアプリへのAPIキー同梱は、解析により露出し得るため、**漏洩前提**の被害限定策を必須とする。

---

## 5. 方式概要（アーキテクチャ）

### 5.1 既定方式：クライアント直結（ローカル完結）

* クライアントがYouTube APIに直接接続し、コメントを取得する。
* コメントやユーザー情報は既定でローカルに保持（必要に応じてユーザー操作でエクスポート）。
* 運営側サーバは必須ではない（ただし**リモート設定配布**は推奨）。

### 5.2 推奨補助：リモート設定（Remote Config）

* キーの切替・機能フラグ・バックオフ係数などを、軽量な設定配布で制御する。
* YouTubeコメント等のデータ本体は送らない（プライバシー・負荷の観点）。

---

## 6. 機能要件

### 6.1 URL入力・配信識別

* FR-001：ユーザーはYouTube動画URLを入力（貼り付け）できる。
* FR-002：アプリはURLから videoId を抽出できる（短縮URL/通常URL/埋め込みURL等）。
* FR-003：入力値が不正な場合、ユーザーに原因（形式不正、動画未存在等）を提示する。

### 6.2 liveChatId の取得

* FR-010：動画がライブ配信中の場合、APIから liveChatId（activeLiveChatId）を取得できる。
* FR-011：ライブでない場合は「非ライブ」「終了」等の状態を表示し、取得を停止する。
* FR-012：取得した liveChatId はセッション中キャッシュし、不要な再取得を避ける。

### 6.3 コメント取得（gRPC streamList）

* FR-020：既定で streamList（gRPC server-streaming）によりコメントを受信する。
* FR-021：受信メッセージは少なくとも以下の属性を保持する：

  * messageId（一意）
  * timestamp（受信/生成時刻）
  * author（表示名、チャンネルID等取得可能範囲）
  * message（本文または種別に応じた表現）
  * messageType（通常/スパチャ/メンバー等。取得可能な範囲で）
* FR-022：切断時は、最後に受領した nextPageToken を保持し、pageToken として再接続を試みる。
* FR-023：再接続は指数バックオフ＋ジッタを用い、短時間の連続再接続を避ける。
* FR-024：再接続時の重複に備え、messageId により重複排除する。

### 6.4 フォールバック（任意）

* FR-030：gRPCが利用不可・恒常的に失敗する環境では、liveChatMessages.list（ポーリング）へ切替可能とする（機能フラグ）。
* FR-031：ポーリング方式では、APIが返す推奨間隔に従い、過剰なリクエストを行わない。

### 6.5 表示・外部連携

* FR-040：アプリ内でリアルタイムにコメント表示できる。
* FR-041：ローカル連携のために以下のいずれか（または複数）を提供できる：

  * ローカルHTTP API
  * ローカルWebSocket
  * ファイル出力（JSONL/CSV等）
* FR-042：外部アクセスは既定で無効／ローカル限定とし、ユーザーが明示的に許可した場合のみ拡張する。

### 6.6 ログ・レポート

* FR-050：アプリは稼働ログ（接続、切断、エラー、再接続理由、環境情報の一部）をローカルに記録する。
* FR-051：ユーザー操作で「レポート作成（zip）」を生成し、サポートに提出できる。
* FR-052：レポートに含める情報は最小限とし、コメント本文など個人情報性の高い情報は既定で含めない（またはマスクする）。

### 6.7 OAuthログイン（オプション機能）

* FR-060：限定配信・要認可機能のため、ユーザーがGoogleアカウントでログインできる。
* FR-061：ログイン状態でのみ有効な機能（例：限定配信、保留コメント等）はUIで明示する。
* FR-062：トークンはOSの安全な保管領域（Keychain/DPAPI等）を優先し、平文保存を禁止する。

---

## 7. 非機能要件

### 7.1 性能・スケーラビリティ

* NFR-001：1インスタンスで複数配信枠（例：最大N枠）を同時監視できる（Nは別途決定）。
* NFR-002：通常時、コメント表示遅延（受信→表示）は目標 P95 1秒以内（端末性能に依存）。
* NFR-003：CPU/メモリ使用量が配信枠数に対して線形増加し、異常増加しない。

### 7.2 可用性・信頼性

* NFR-010：一時的なネットワーク断、YouTube側の断続的エラーに対して自動復旧する。
* NFR-011：復旧不能（配信終了、チャット無効等）の場合、ユーザーに分かる理由で停止する。

### 7.3 セキュリティ（APIキー運用の核心）

* NFR-020：APIキーはアプリに同梱され得るが、**漏洩前提**で以下を必須とする。

### 7.3.1 Google Cloud 側の制御（必須）

* NFR-020-1：APIキーには **API制限（YouTube Data API のみに限定）** を必須適用する。
* NFR-020-2：不要なAPI（例：Places, Maps, Cloud系など）には一切利用できないこと。
* NFR-020-3：キーは環境別（prod/stg/dev）に分離し、**テスト用キーが本番に混入しない**こと。

### 7.3.2 アプリ同梱キーの被害限定（必須）

* NFR-020-4：APIキーは単一運用を禁止し、以下のいずれか（または複合）で分割できる設計とする。

  * 用途別（例：liveChatId取得用／streamList接続用／補助機能用）
  * リリースチャネル別（stable/beta/nightly）
  * コホート別（例：ユーザー母集団を複数群に分け、キーを分配）
* NFR-020-5：キーの切替は**アプリ更新を待たず**に実施できる（Remote Config による配布、もしくはアプリ内フェイルオーバー）。
* NFR-020-6：アプリは複数キーを保持でき、優先順位付きで試行する（例：Primary→Secondary→Tertiary）。
* NFR-020-7：キー切替時にユーザー体験を毀損しない（例：接続中のストリームは自然切断で再接続時に新キーへ、または強制再接続の実施）。

### 7.3.3 監視・検知（必須）

* NFR-020-8：運用側は以下の指標を監視し、閾値超過時にアラートを発報する。

  * 日次クォータ消費の急増（前日比、時間当たり消費レート）
  * 4xx（特に403/429）比率の急増
  * 5xx比率の急増
* NFR-020-9：濫用・漏洩が疑われる場合、**キー無効化→代替キーへの切替→段階的復旧**の手順をRunbook化する。

### 7.3.4 キー保管・ビルド安全性（必須）

* NFR-020-10：ソースコードリポジトリに平文キーをコミットしない（CI/CDのSecret管理を使用）。
* NFR-020-11：ビルド成果物にキーが含まれる場合、難読化・分割保持等の軽減策を実施するが、**秘匿保証はしない**（漏洩前提で運用設計する）。
* NFR-020-12：キーのアクセス権限は最小化し、発行・無効化・ローテ権限は限定された運用者に付与する（職務分掌）。

### 7.3.5 例外：より堅牢にする代替方式（任意）

* NFR-020-13：セキュリティ要件がより厳しい場合は、サーバプロキシ（IP制限可能）またはOAuth必須化への移行計画を別途策定できる。

### 7.3.6 推奨（難易度が比較的やさしい）運用モデルの要件化

本節は、実装・運用コストを抑えつつ、漏洩・濫用時の復旧性を確保するための**推奨最小セット**である。

* NFR-020-14：キー分割はまず以下の2軸に限定する（初期リリースの要件）。

  * 環境別：prod / stg / dev
  * リリースチャネル別：stable / beta
    ※コホート分割は将来拡張（初期は非必須）。

* NFR-020-15：各（環境×チャネル）につき **Primary/Secondary の2キー**を運用する（最低2本）。

  * Primary：通常運用
  * Secondary：緊急切替用（ローテーション/濫用時の即時退避）

* NFR-020-16：Remote Config は「静的JSON配布」を既定とし、以下を満たす。

  * 配布先はHTTPSの固定ドメイン（例：CDN）で提供し、アプリにドメインをハードコードする。
  * 設定はキャッシュし、取得失敗時は直近の有効設定で継続する（オフライン耐性）。
  * 取得頻度（TTL）を設け、過剰なポーリングを行わない。

* NFR-020-17：Remote Config で配布する情報（初期リリースの要件）は以下とする。

  * active_key_slot：Primary/Secondary のどちらを使用するか
  * disable_new_connections：新規接続停止（Kill Switch）
  * max_watch_streams：同時監視枠数上限（緊急縮退用）
  * backoff_profile：再接続バックオフ係数（緊急抑制用）

* NFR-020-18：Remote Config の改ざん対策として、設定JSONに署名を付与し、アプリで検証できること（推奨・容易な範囲）。

  * 署名方式は実装負荷の低い方式を採用（例：Ed25519の署名＋公開鍵をアプリに同梱）。
  * 検証不能（署名不正）の場合は設定を無効とし、直近の有効設定で継続する。

* NFR-020-19：キー切替（Primary↔Secondary）は Remote Config の切替のみで完結し、**アプリ更新を不要**とする（初期リリースの要件）。

  * 新キー投入（Primary/Secondaryの差替え）は運用都合によりアプリ更新を伴ってもよいが、初期目標は「Remote Config での差替え」を優先する。

## 7.4 プライバシー プライバシー プライバシー

* NFR-030：ユーザーの同意なしに、コメント本文・視聴者識別情報等を外部送信しない。
* NFR-031：テレメトリを実装する場合はオプトインとし、送信項目・目的・停止方法を明示する。

### 7.5 互換性

* NFR-040：Windows/macOSで同等の主要機能が動作する。
* NFR-041：企業ネットワーク等で gRPC が阻害される環境を想定し、フォールバックや明確なエラー表示を提供する。

---

## 8. クォータ・レート制御要件

* QR-001：取得方式は既定で streamList とし、ポーリング回数を最小化する。
* QR-002：APIコール数を削減するため、以下を実施する：

  * liveChatId のキャッシュ
  * 冗長な再取得の抑制
  * 失敗時のバックオフ
* QR-003：プロジェクトのクォータ状況は運用側で定期確認し、枯渇兆候時の緩和策（機能制限・キー切替・配布停止等）をRunbook化する。

---

## 9. 監視・運用要件（クライアント中心）

### 9.1 ローカル監視（ユーザー向け）

* OPS-001：接続状態（接続中/再接続中/停止理由）をUIに表示する。
* OPS-002：直近エラーコード・再接続回数・受信レートを簡易表示できる。

### 9.2 運営監視（最小構成）

* OPS-010：サポート調査は、ユーザー提出のレポート（zip）＋ログを前提に手順化する。
* OPS-011：Remote Config を導入する場合、配布基盤の可用性（障害時はデフォルト設定で継続）を担保する。

---

## 10. エラーハンドリング要件

* EH-001：代表的な停止理由をユーザーに分かる表現で通知する（例：配信終了、チャット無効、限定配信でログイン必要、権限不足、レート制限、ネットワーク不良）。
* EH-002：再試行が有効なエラー（ネットワーク、5xx等）と、無効なエラー（配信終了、無効チャット等）を区別する。
* EH-003：再接続が一定回数失敗した場合、ユーザーに手動介入（URL再入力、ログイン、再起動）の指示を提示する。

---

## 11. 受入基準（Acceptance Criteria）

1. **ログイン不要**で、公開ライブ配信URLからコメントが取得・表示できる。
2. gRPC接続が切断されても、バックオフ付きで自動復旧し、重複表示が抑制される。
3. APIキーはユーザーに要求しない（UIに入力欄が存在しない）。
4. 推奨・容易な運用モデル（初期リリースの要件）

   * キー分割が「環境別（prod/stg/dev）×チャネル別（stable/beta）」で実現されている。
   * 各（環境×チャネル）に Primary/Secondary の2キーを持つ。
   * Remote Config（静的JSON配布）を実装し、active_key_slot の切替で Primary↔Secondary が切り替わる。
   * Remote Config の取得失敗時も直近の有効設定で継続できる。
   * Remote Config の署名検証に失敗した場合、設定を適用しない。
   * Remote Config により disable_new_connections / max_watch_streams / backoff_profile を制御できる。
5. レポート作成（zip）により、サポートが最低限の障害解析（エラー種別・接続推移）を行える。

## 12. リスク・課題と対策 リスク・課題と対策

* R-001：APIキー漏洩・濫用

  * 対策：API制限、キー分割（環境別・チャネル別・コホート別）、監視、ローテーション、Kill Switch、（必要に応じて）サーバプロキシ/OAuth化
* R-002：クォータ枯渇

  * 対策：streamList優先、無駄なAPI削減、枯渇時の段階的制限、（必要なら）監査→クォータ拡張申請
* R-003：gRPCが企業NWで遮断

  * 対策：フォールバック（list）または「環境要因」を明示、接続診断
* R-004：限定配信要件

  * 対策：OAuthログイン導線と機能境界の明確化

---

## 13. 付録：推奨Runbook（キー漏洩対策・ローテ運用）

本Runbookは「APIキー同梱（ユーザー入力不要）」方式における、**漏洩・濫用時の被害最小化**と**短時間復旧**を目的とする。

### 13.1 役割分担（RACI例）

* 事業責任者（PO）：方針決定（機能制限・告知）／重大インシデント承認
* 運用責任者（Ops/SRE）：検知、一次対応、キー切替の実施
* 開発（Client）：アプリ側フェイルオーバー、Remote Config対応、緊急リリース
* セキュリティ：原因分析、再発防止策の設計・レビュー

### 13.2 平時の予防策（必須）

1. **キー分割**

   * prod/stg/dev を分離
   * stable/beta を分離
   * 可能ならコホート分割（例：ユーザーIDのハッシュでA〜D群に割当）
2. **Google Cloud 側の制限**

   * API制限：YouTube Data API のみに限定
3. **フェイルオーバー設計**

   * アプリはキーリスト（Primary/Secondary/Tertiary）を保持
   * 再接続時に次キーへ自動切替（一定回数の認証/レート失敗で昇格）
4. **Remote Config（推奨）**

   * キーID（参照キー）と優先順、フォールバック有無、バックオフ係数を配布
   * Remote Config 障害時は安全側のデフォルトで継続
5. **監視**

   * クォータ消費レート、403/429急増、5xx急増をアラート化

### 13.3 濫用・漏洩の検知条件（推奨閾値例）

* 検知A（クォータ）：1時間あたり消費が過去7日同時間帯の **3倍** を超過
* 検知B（エラー）：403/429比率が **5分平均で20%超** かつ増加傾向
* 検知C（連鎖障害）：再接続回数が短時間に急増（ユーザー影響が顕在化）

※閾値は初期値として置き、実測で調整する。

### 13.4 一次対応（Triage）

1. 影響範囲の把握

   * 影響：特定バージョン／特定コホート／全体
   * 症状：接続不可、切断ループ、取得遅延
2. 要因の切り分け

   * クォータ枯渇（当日上限到達）
   * 濫用（不自然な消費レート上昇）
   * YouTube側障害（5xx中心）
3. 暫定緩和

   * フォールバック（list）を有効化する場合は、最小頻度・最小範囲で限定
   * 多重再接続を抑えるため、バックオフ係数を引き上げ

### 13.5 キーローテーション手順（標準：推奨・容易な運用モデル）

**目的**：漏洩が疑われるキーを退避し、短時間で機能回復する。

#### 方式

* 既定：Primary/Secondary のスロット切替は Remote Config で実施（アプリ更新不要）。
* 新キー投入：原則は Remote Config により差替え可能な設計を推奨するが、運用上の制約がある場合は緊急パッチで投入する。

#### 手順

1. 影響確認（運用者）

* クォータ消費レート／403/429比率／接続成功率を確認し、濫用・枯渇・YouTube側障害を切り分ける。

2. 暫定緩和（運用者）

* Remote Config で backoff_profile を強化、max_watch_streams を縮小、必要なら disable_new_connections を有効化。

3. スロット切替（運用者）

* Remote Config の active_key_slot を Secondary へ切替。
* アプリは次回再接続からSecondaryを使用する（必要なら強制再接続フラグで切替加速）。

4. 旧キーの無効化（運用者）

* 切替後に状況が安定したことを確認し、漏洩が疑われる旧スロット（Primary）キーを無効化。

5. 復旧確認（運用者）

* 消費レート・エラー率・接続成功率が通常レンジに戻ったことを確認。

6. 恒久対応（セキュリティ/開発）

* 漏洩経路の分析と再発防止（キー分割見直し、監視強化、署名検証の徹底）。

### 13.6 緊急停止（Kill Switch） 緊急停止（Kill Switch）

* 重大な濫用で全体枯渇が不可避な場合、Remote Config で機能を一時停止できる。

  * 例：新規接続禁止、監視枠数の上限を1に縮小、フォールバック無効化
* 停止時はUIに明確な理由と復旧状態を表示し、ユーザーの混乱を抑える。

### 13.7 ユーザー告知テンプレ（要点）

* 事象：YouTube側制限／運用側メンテ／一時停止
* 影響：コメント取得が不安定／一部機能停止
* 回避：時間を置く、限定配信はログイン、レポート作成
* 収束：復旧済み／継続調査

---

## 14. 未決事項（別途決定）

* 同時監視枠数の上限（既定値・端末性能要件）
* フォールバック（list）の有効化方針と間隔（既定OFFか、環境診断時のみONか）
* テレメトリ（オプトイン）の有無と送信項目（クラッシュのみ/品質メトリクス含む等）
* 対応OS/配布形態（インストーラ、オートアップデート方式）

※以下は初期リリースで採用を決定（本仕様の既定）：

* キー分割：環境別（prod/stg/dev）×チャネル別（stable/beta）、各2本（Primary/Secondary）
* Remote Config：静的JSON（HTTPS固定ドメイン）＋署名検証＋キャッシュ継続
